#!/bin/bash
set -euo pipefail  # Exit on error, undefined variables, and pipe failures

# For logging details
echo "Backup script started at $(date --iso-8601=ns)"

# ============================================================================
# Configuration
# ============================================================================

SCRIPT_DIR="$(dirname "$0")"
RESTIC_REPO="/mnt/sda1/restic-repo"
HDD_DEVICE="/dev/sda1"
HDD_MOUNT="/mnt/sda1"
# Adjust this path to your Docker directory
DOCKER_BASE="${DOCKER_BASE:-$HOME/docker}"

# MQTT Topics
MQTT_HOST="localhost"
MQTT_PORT="1883"
STATE_TOPIC="homeassistant/sensor/backup_status/state"
ATTRIBUTES_TOPIC="homeassistant/sensor/backup_status/attributes"
DISCOVERY_TOPIC="homeassistant/sensor/backup_status/config"

# Device info for Home Assistant
DEVICE_ID="restic_backup"
DEVICE_NAME="Restic Backup"

# ============================================================================
# Load Credentials
# ============================================================================

# Load MQTT credentials with validation
MQTT_CREDENTIALS="$SCRIPT_DIR/.mqtt_credentials"
if [[ ! -f "$MQTT_CREDENTIALS" ]]; then
    echo "ERROR: MQTT credentials file not found at $MQTT_CREDENTIALS" >&2
    echo "Please create it from .mqtt_credentials.example" >&2
    exit 1
fi

# Check file permissions (should be 600)
MQTT_PERMS=$(stat -c %a "$MQTT_CREDENTIALS")
if [[ "$MQTT_PERMS" != "600" ]]; then
    echo "WARNING: Insecure permissions on $MQTT_CREDENTIALS (found: $MQTT_PERMS, expected: 600)" >&2
fi

source "$MQTT_CREDENTIALS"

# Validate required MQTT variables are set
if [[ -z "${MQTT_USER:-}" ]] || [[ -z "${MQTT_PASSWORD:-}" ]]; then
    echo "ERROR: MQTT_USER or MQTT_PASSWORD not set in $MQTT_CREDENTIALS" >&2
    exit 1
fi

# Load Restic password with validation
RESTIC_ENV="$SCRIPT_DIR/.restic.env"
if [[ ! -f "$RESTIC_ENV" ]]; then
    echo "ERROR: Restic credentials file not found at $RESTIC_ENV" >&2
    echo "Please create it from .restic.env.example" >&2
    exit 1
fi

# Check file permissions (should be 600)
RESTIC_PERMS=$(stat -c %a "$RESTIC_ENV")
if [[ "$RESTIC_PERMS" != "600" ]]; then
    echo "WARNING: Insecure permissions on $RESTIC_ENV (found: $RESTIC_PERMS, expected: 600)" >&2
fi

source "$RESTIC_ENV"

# Validate required variables are set
if [[ -z "${RESTIC_PASSWORD:-}" ]]; then
    echo "ERROR: RESTIC_PASSWORD is not set in $RESTIC_ENV" >&2
    exit 1
fi

# ============================================================================
# Helper Functions
# ============================================================================

# Send MQTT Discovery message (only needed once, but idempotent)
send_discovery() {
    local discovery_payload=$(cat <<EOF
{
  "name": "Status",
  "object_id": "restic_backup_status",
  "unique_id": "restic_backup_status",
  "state_topic": "$STATE_TOPIC",
  "json_attributes_topic": "$ATTRIBUTES_TOPIC",
  "icon": "mdi:backup-restore",
  "device": {
    "identifiers": ["$DEVICE_ID"],
    "name": "$DEVICE_NAME",
    "model": "Restic Backup Script",
    "manufacturer": "Homelab"
  }
}
EOF
)
    mosquitto_pub -h "$MQTT_HOST" -p "$MQTT_PORT" \
      -u "$MQTT_USER" -P "$MQTT_PASSWORD" \
      -t "$DISCOVERY_TOPIC" \
      -m "$discovery_payload" \
      -r  # Retain discovery message
}

# Send state update
send_state() {
    local state="$1"
    echo "MQTT: Sending state: $state"
    mosquitto_pub -h "$MQTT_HOST" -p "$MQTT_PORT" \
      -u "$MQTT_USER" -P "$MQTT_PASSWORD" \
      -t "$STATE_TOPIC" \
      -m "$state"
}

# Send attributes (JSON with backup details)
send_attributes() {
    local attributes="$1"
    echo "MQTT: Sending attributes: $attributes"
    mosquitto_pub -h "$MQTT_HOST" -p "$MQTT_PORT" \
      -u "$MQTT_USER" -P "$MQTT_PASSWORD" \
      -t "$ATTRIBUTES_TOPIC" \
      -m "$attributes"
}

# Parse restic stats output
parse_restic_stats() {
    local stats_output="$1"
    local files_new=$(echo "$stats_output" | grep "Files:" | awk '{print $2}' | grep -o '[0-9]*' || echo "0")
    local files_changed=$(echo "$stats_output" | grep "Files:" | awk '{print $4}' | grep -o '[0-9]*' || echo "0")
    local dirs_new=$(echo "$stats_output" | grep "Dirs:" | awk '{print $2}' | grep -o '[0-9]*' || echo "0")
    local added_size=$(echo "$stats_output" | grep "Added to the repository:" | awk '{print $5}' || echo "0")

    echo "$files_new|$files_changed|$dirs_new|$added_size"
}

# Cleanup function for error handling
cleanup() {
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo "ERROR: Backup failed with exit code $exit_code"

        local error_json=$(cat <<EOF
{
  "last_run": "$(date --iso-8601=seconds)",
  "duration_seconds": $(($(date +%s) - START_TIME)),
  "error": "Backup failed with exit code $exit_code",
  "last_error_time": "$(date --iso-8601=seconds)"
}
EOF
)
        send_state "failed"
        send_attributes "$error_json"
    fi

    # Always try to unmount
    if mountpoint -q "$HDD_MOUNT"; then
        echo "Unmounting $HDD_MOUNT..."
        sudo umount "$HDD_MOUNT" 2>/dev/null || true
    fi

    # Clean credentials from memory (security best practice)
    echo "Removing secrets from memory..."
    unset RESTIC_PASSWORD MQTT_PASSWORD
}

trap cleanup EXIT

# ============================================================================
# Main Backup Process
# ============================================================================

START_TIME=$(date +%s)

# Send MQTT Discovery
send_discovery

# Send initial state
send_state "running"
send_attributes "{\"last_run\": \"$(date --iso-8601=seconds)\", \"status\": \"Starting backup...\"}"

# Mount HDD with correct permissions
echo "Mounting $HDD_DEVICE to $HDD_MOUNT..."
sudo mount "$HDD_DEVICE" "$HDD_MOUNT" -o rw,uid=$UID,user,dmask=007,fmask=117

# Initialize counters
TOTAL_FILES_NEW=0
TOTAL_FILES_CHANGED=0
TOTAL_DIRS_NEW=0
TOTAL_ADDED_SIZE="0 B"

# ============================================================================
# Backup Immich
# ============================================================================

echo ""
echo "=========================================="
echo "Starting Immich Backup"
echo "=========================================="
send_attributes "{\"last_run\": \"$(date --iso-8601=seconds)\", \"status\": \"Backing up Immich...\"}"

# Run backup and capture output (works in both interactive and cron)
IMMICH_OUTPUT=$(restic -r "$RESTIC_REPO" backup "$DOCKER_BASE/immich/library" --verbose 2>&1)
echo "$IMMICH_OUTPUT"
IMMICH_STATS=$(parse_restic_stats "$IMMICH_OUTPUT")

IFS='|' read -r immich_files_new immich_files_changed immich_dirs_new immich_added_size <<< "$IMMICH_STATS"
echo "Immich backup complete: $immich_files_new new files, $immich_files_changed changed files"

# ============================================================================
# Backup Paperless
# ============================================================================

echo ""
echo "=========================================="
echo "Starting Paperless Backup"
echo "=========================================="
send_attributes "{\"last_run\": \"$(date --iso-8601=seconds)\", \"status\": \"Exporting Paperless DB...\"}"

# Export Paperless database
DB_BACKUP_FILE="$DOCKER_BASE/paperless/library/backup/paperless_$(date +%Y-%m-%d_%H_%M_%S).sql.gz"
echo "Exporting Paperless database to $DB_BACKUP_FILE..."
docker exec -t paperless-db-1 pg_dumpall -v -c -U paperless | gzip > "$DB_BACKUP_FILE"

send_attributes "{\"last_run\": \"$(date --iso-8601=seconds)\", \"status\": \"Backing up Paperless...\"}"

# Run backup and capture output (works in both interactive and cron)
PAPERLESS_OUTPUT=$(restic -r "$RESTIC_REPO" backup "$DOCKER_BASE/paperless/library" --verbose 2>&1)
echo "$PAPERLESS_OUTPUT"
PAPERLESS_STATS=$(parse_restic_stats "$PAPERLESS_OUTPUT")

IFS='|' read -r paperless_files_new paperless_files_changed paperless_dirs_new paperless_added_size <<< "$PAPERLESS_STATS"
echo "Paperless backup complete: $paperless_files_new new files, $paperless_files_changed changed files"

# ============================================================================
# Backup Home Assistant
# ============================================================================

echo ""
echo "=========================================="
echo "Starting Home Assistant Backup"
echo "=========================================="
send_attributes "{\"last_run\": \"$(date --iso-8601=seconds)\", \"status\": \"Backing up Home Assistant...\"}"

# Backup Home Assistant configuration directory
# Includes: configuration.yaml, automations.yaml, scripts.yaml, secrets.yaml,
#           custom_components/, backup/ (HA's own full backups)
# Excludes: .storage/ (included in HA backups), .cloud/ (Nabu Casa, not needed)
# Note: Using --ignore-inode to handle locked files (e.g., database, logs)
#       Exit code 3 (incomplete) is downgraded to success if most files backed up
HOMEASSISTANT_OUTPUT=$(restic -r "$RESTIC_REPO" backup "$DOCKER_BASE/homeassistant/homeassistant/config" \
  --ignore-inode \
  --exclude="*.log" \
  --exclude="*.db" \
  --exclude="*.db-shm" \
  --exclude="*.db-wal" \
  --exclude=".storage" \
  --exclude=".cloud" \
  --verbose 2>&1) || HOMEASSISTANT_EXIT_CODE=$?

# Restic exit code 3 = incomplete backup (some files couldn't be read)
# This is acceptable for HA as some files may be locked during operation
if [[ ${HOMEASSISTANT_EXIT_CODE:-0} -eq 3 ]]; then
    echo "Warning: Home Assistant backup incomplete (some files locked), but continuing..."
    HOMEASSISTANT_EXIT_CODE=0
elif [[ ${HOMEASSISTANT_EXIT_CODE:-0} -ne 0 ]]; then
    echo "ERROR: Home Assistant backup failed with exit code $HOMEASSISTANT_EXIT_CODE"
    exit $HOMEASSISTANT_EXIT_CODE
fi
echo "$HOMEASSISTANT_OUTPUT"
HOMEASSISTANT_STATS=$(parse_restic_stats "$HOMEASSISTANT_OUTPUT")

IFS='|' read -r homeassistant_files_new homeassistant_files_changed homeassistant_dirs_new homeassistant_added_size <<< "$HOMEASSISTANT_STATS"
echo "Home Assistant backup complete: $homeassistant_files_new new files, $homeassistant_files_changed changed files"

# ============================================================================
# Calculate Totals
# ============================================================================

TOTAL_FILES_NEW=$((immich_files_new + paperless_files_new + homeassistant_files_new))
TOTAL_FILES_CHANGED=$((immich_files_changed + paperless_files_changed + homeassistant_files_changed))
TOTAL_DIRS_NEW=$((immich_dirs_new + paperless_dirs_new + homeassistant_dirs_new))

# ============================================================================
# Get Repository Stats
# ============================================================================

echo ""
echo "=========================================="
echo "Repository Statistics"
echo "=========================================="

REPO_STATS=$(restic -r "$RESTIC_REPO" stats --mode raw-data --json 2>/dev/null || echo "{}")
REPO_SIZE_BYTES=$(echo "$REPO_STATS" | jq -r '.total_size // 0')
REPO_SIZE_GB=$(echo "scale=2; $REPO_SIZE_BYTES / 1024 / 1024 / 1024" | bc)

# Count snapshots
SNAPSHOT_COUNT=$(restic -r "$RESTIC_REPO" snapshots --json 2>/dev/null | jq '. | length' || echo "0")

echo "Repository size: ${REPO_SIZE_GB} GB"
echo "Total snapshots: $SNAPSHOT_COUNT"

# ============================================================================
# Unmount and Finalize
# ============================================================================

echo "Unmounting $HDD_MOUNT..."
sudo umount "$HDD_MOUNT"

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "=========================================="
echo "Backup Complete!"
echo "=========================================="
echo "Duration: ${DURATION}s"
echo "Files added: $TOTAL_FILES_NEW"
echo "Files changed: $TOTAL_FILES_CHANGED"
echo "Directories added: $TOTAL_DIRS_NEW"

# ============================================================================
# Send Final MQTT Update
# ============================================================================

SUCCESS_JSON=$(cat <<EOF
{
  "last_run": "$(date --iso-8601=seconds)",
  "duration_seconds": $DURATION,
  "files_new": $TOTAL_FILES_NEW,
  "files_changed": $TOTAL_FILES_CHANGED,
  "dirs_new": $TOTAL_DIRS_NEW,
  "immich_files_new": $immich_files_new,
  "immich_files_changed": $immich_files_changed,
  "paperless_files_new": $paperless_files_new,
  "paperless_files_changed": $paperless_files_changed,
  "homeassistant_files_new": $homeassistant_files_new,
  "homeassistant_files_changed": $homeassistant_files_changed,
  "repository_size_gb": $REPO_SIZE_GB,
  "snapshot_count": $SNAPSHOT_COUNT,
  "last_success_time": "$(date --iso-8601=seconds)"
}
EOF
)

send_state "success"
send_attributes "$SUCCESS_JSON"

echo "MQTT notifications sent successfully"
echo "Backup script completed at $(date --iso-8601=ns)"
