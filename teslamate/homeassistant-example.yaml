# =============================================================================
# Home Assistant Integration for Teslamate
# =============================================================================
# Add this to your Home Assistant configuration.yaml or include as separate file.
#
# Prerequisites:
# 1. Teslamate running with MQTT enabled (connects to your Mosquitto broker)
# 2. MQTT integration configured in Home Assistant
#
# Teslamate MQTT topic structure:
#   teslamate/cars/<car_id>/<sensor_name>
#
# For more sensors see:
#   https://docs.teslamate.org/docs/integrations/home-assistant
# =============================================================================

# -----------------------------------------------------------------------------
# MQTT Sensors for Teslamate
# -----------------------------------------------------------------------------
mqtt:
  sensor:
    # Battery and Range
    - name: "Tesla Battery Level"
      state_topic: "teslamate/cars/1/battery_level"
      unit_of_measurement: "%"
      icon: mdi:battery
      device_class: battery

    - name: "Tesla Rated Range"
      state_topic: "teslamate/cars/1/rated_battery_range_km"
      unit_of_measurement: "km"
      icon: mdi:map-marker-distance

    - name: "Tesla Est Range"
      state_topic: "teslamate/cars/1/est_battery_range_km"
      unit_of_measurement: "km"
      icon: mdi:map-marker-distance

    # Charging Information
    - name: "Tesla Plugged In"
      state_topic: "teslamate/cars/1/plugged_in"
      icon: mdi:ev-plug-type2

    - name: "Tesla Charging State"
      state_topic: "teslamate/cars/1/state"
      icon: mdi:car-electric

    - name: "Tesla Charge Energy Added"
      state_topic: "teslamate/cars/1/charge_energy_added"
      unit_of_measurement: "kWh"
      icon: mdi:lightning-bolt
      device_class: energy

    - name: "Tesla Charger Power"
      state_topic: "teslamate/cars/1/charger_power"
      unit_of_measurement: "kW"
      icon: mdi:flash
      device_class: power

    # Location
    - name: "Tesla Latitude"
      state_topic: "teslamate/cars/1/latitude"
      icon: mdi:crosshairs-gps

    - name: "Tesla Longitude"
      state_topic: "teslamate/cars/1/longitude"
      icon: mdi:crosshairs-gps

    # Odometer
    - name: "Tesla Odometer"
      state_topic: "teslamate/cars/1/odometer"
      unit_of_measurement: "km"
      icon: mdi:counter

    # Temperature
    - name: "Tesla Inside Temp"
      state_topic: "teslamate/cars/1/inside_temp"
      unit_of_measurement: "°C"
      icon: mdi:thermometer
      device_class: temperature

    - name: "Tesla Outside Temp"
      state_topic: "teslamate/cars/1/outside_temp"
      unit_of_measurement: "°C"
      icon: mdi:thermometer
      device_class: temperature

# -----------------------------------------------------------------------------
# Template Sensors for Charging Costs
# -----------------------------------------------------------------------------
template:
  - sensor:
      # Cost per charging session (current/last session)
      - name: "Tesla Charging Cost Current"
        unique_id: tesla_charging_cost_current
        unit_of_measurement: "EUR"
        icon: mdi:currency-eur
        device_class: monetary
        state: >
          {{ (states('sensor.tesla_charge_energy_added') | float(0) * 0.45) | round(2) }}
        attributes:
          price_per_kwh: 0.45
          energy_added: "{{ states('sensor.tesla_charge_energy_added') }}"

# -----------------------------------------------------------------------------
# Utility Meter for Monthly Tracking
# -----------------------------------------------------------------------------
# This creates a sensor that resets monthly to track charging costs
utility_meter:
  tesla_energy_monthly:
    source: sensor.tesla_charge_energy_added
    cycle: monthly
    name: "Tesla Energy Monthly"

# After adding utility_meter, create a template for monthly costs:
# template:
#   - sensor:
#       - name: "Tesla Charging Cost Monthly"
#         unique_id: tesla_charging_cost_monthly
#         unit_of_measurement: "EUR"
#         icon: mdi:currency-eur
#         state: >
#           {{ (states('sensor.tesla_energy_monthly') | float(0) * 0.45) | round(2) }}

# -----------------------------------------------------------------------------
# Automations (Optional)
# -----------------------------------------------------------------------------
# Example: Notify when charging starts
# automation:
#   - alias: "Tesla Charging Started"
#     trigger:
#       - platform: state
#         entity_id: sensor.tesla_charging_state
#         to: "charging"
#     action:
#       - service: notify.mobile_app
#         data:
#           title: "Tesla Charging"
#           message: "Charging started at {{ states('sensor.tesla_charger_power') }} kW"

# Example: Notify when charging complete
# automation:
#   - alias: "Tesla Charging Complete"
#     trigger:
#       - platform: state
#         entity_id: sensor.tesla_charging_state
#         from: "charging"
#         to: "complete"
#     action:
#       - service: notify.mobile_app
#         data:
#           title: "Tesla Charged"
#           message: >
#             Added {{ states('sensor.tesla_charge_energy_added') }} kWh
#             ({{ (states('sensor.tesla_charge_energy_added') | float * 0.45) | round(2) }} EUR)
