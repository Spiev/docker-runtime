# Fail2Ban filter for Nginx 4xx responses
# ============================================================================
# Matches 401 Unauthorized, 403 Forbidden, 404 Not Found responses
# These indicate failed auth attempts, blocked access, or probing
#
# Protects all services behind nginx reverse proxy:
# - Immich (DOMAIN1)
# - Paperless (DOMAIN2)
# - FreshRSS (DOMAIN3)
# - Home Assistant (DOMAIN4)
# ============================================================================

[Definition]

# Match 401/403/404 responses
# Log format: IP - - [timestamp] "METHOD /path HTTP/version" STATUS size "referer" "user-agent"
failregex = ^<HOST> -.* - \[[^\]]*\] "(?:GET|POST|HEAD|PUT|DELETE) \S* HTTP\/1\.[01]" (401|403|404) \d+ ".*" ".*"$

# Ignore legitimate 404s (favicons, robots.txt, etc.)
ignoreregex = ^<HOST> .* "(GET|HEAD) /(favicon\.ico|robots\.txt|apple-touch-icon|site\.webmanifest) HTTP
